<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <title>Dashboard Produzione Barilla</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #eef2f7;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        button {
            padding: 10px 15px;
            margin: 5px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background-color: #28a745;
            color: white;
            font-size: 14px;
        }

        button:hover {
            background-color: #218838;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th,
        td {
            padding: 8px 12px;
            border: 1px solid #ddd;
            text-align: center;
        }

        th {
            background-color: #28a745;
            color: white;
        }

        #graficoView {
            display: none;
            margin-top: 20px;
        }

        canvas {
            max-width: 700px;
            margin-top: 20px;
        }

        input[type=date],
        select {
            padding: 10px 15px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            background-color: #28a745;
            color: white;
            font-size: 14px;
        }

        input[type=date]:hover,
        select:hover {
            background-color: #218838;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Dashboard Produzione Barilla</h1>

        <button onclick="fetchData('/genera-quantita', 'quantita')">üì¶ Genera Quantit√†</button>
        <button onclick="fetchData('/genera-parametri', 'parametri')">‚öôÔ∏è Genera Parametri</button>
        <button onclick="fetchData('/calcola-tempo', 'tempo')">‚è± Calcola Tempo Produzione</button>
        <button onclick="mostraVistaGrafico()">üìà Genera Grafico Produzione</button>

        <h3 id="capacitaComplessiva"></h3>
        <h3 id="tempoProduzioneTotale"></h3>

        <div id="tabellaDati">
            <table>
                <tr>
                    <th>Prodotto</th>
                    <th>Quantit√†</th>
                    <th>Tempo Unitario (ore)</th>
                    <th>Capacit√† Giornaliera</th>
                    <th>Tempo Totale Prodotto (ore)</th>
                </tr>
                <tr>
                    <td colspan="5">Premi i pulsanti per popolare la tabella...</td>
                </tr>
            </table>
        </div>

        <div id="graficoView">
            <label for="startDate">Da:</label>
            <input type="date"
                id="startDate">
            <label for="endDate">A:</label>
            <input type="date"
                id="endDate">
            <label for="prodottoSelect">Prodotto:</label>
            <select id="prodottoSelect">
                <option value="tutti">Tutti</option>
                <option value="Spaghetti Barilla">Spaghetti Barilla</option>
                <option value="Frollini Mulino Bianco">Frollini Mulino Bianco</option>
                <option value="Pesto Barilla">Pesto Barilla</option>
            </select>
            <button onclick="generaGrafico()">üìä Visualizza Grafico</button>
            <button onclick="tornaAllaTabella()">üîô Torna alla Tabella</button>
            <canvas id="graficoProduzione"></canvas>
        </div>
    </div>

    <script>
        let dati = {};

        async function fetchData(endpoint, type) {
            document.getElementById("tabellaDati").style.display = "block";
            document.getElementById("graficoView").style.display = "none";

            const response = await fetch(endpoint);
            const data = await response.json();

            if (type === 'quantita') {
                for (let prodotto in data) {
                    dati[prodotto] = dati[prodotto] || {};
                    dati[prodotto].quantita = data[prodotto];
                }
            } else if (type === 'parametri') {
                for (let prodotto in data.parametri) {
                    dati[prodotto] = dati[prodotto] || {};
                    dati[prodotto].tempo_unitario = data.parametri[prodotto].tempo_unitario;
                    dati[prodotto].capacita_giornaliera = data.parametri[prodotto].capacita_giornaliera;
                    dati[prodotto].fasi = data.parametri[prodotto].fasi;
                }
                document.getElementById("capacitaComplessiva").textContent =
                    "Capacit√† Giornaliera Complessiva: " + data.capacita_complessiva + " unit√†";
            } else if (type === 'tempo') {
                for (let prodotto in data.dettagli) {
                    dati[prodotto] = dati[prodotto] || {};
                    dati[prodotto].tempo_totale_prodotto = data.dettagli[prodotto].tempo_totale_prodotto;
                    dati[prodotto].fasi_singole = data.dettagli[prodotto].fasi_singole;
                    dati[prodotto].fasi_totali = data.dettagli[prodotto].fasi_totali;
                    dati[prodotto].quantita = data.quantita[prodotto];
                }
                document.getElementById("tempoProduzioneTotale").textContent =
                    "Tempo Totale Produzione Lotto: " + data.tempo_totale_ore + " ore (" + data
                    .tempo_totale_giorni + " giorni)";
            }
            renderTable();
        }

        function renderTable() {
            let output = `
        <table>
            <tr>
                <th>Prodotto</th>
                <th>Quantit√†</th>
                <th>Tempo Unitario (ore)</th>
                <th>Capacit√† Giornaliera</th>
                <th>Durata Singola Fase (ore)</th>
                <th>Durata Totale Fasi (ore)</th>
                <th>Tempo Totale Prodotto (ore)</th>
            </tr>`;

            for (let prodotto in dati) {
                let qta = dati[prodotto].quantita || 0;

                let fasiSingole = dati[prodotto].fasi_singole ?
                    Object.entries(dati[prodotto].fasi_singole).map(([fase, durata]) => `${fase}: ${durata} h`).join(
                        '<br>') : '-';

                let fasiTotali = dati[prodotto].fasi_totali ?
                    Object.entries(dati[prodotto].fasi_totali).map(([fase, durata]) => `${fase}: ${durata} h`).join(
                        '<br>') : '-';

                output += `
            <tr>
                <td>${prodotto}</td>
                <td>${qta}</td>
                <td>${dati[prodotto].tempo_unitario || '-'}</td>
                <td>${dati[prodotto].capacita_giornaliera || '-'}</td>
                <td>${fasiSingole}</td>
                <td>${fasiTotali}</td>
                <td>${dati[prodotto].tempo_totale_prodotto || '-'}</td>
            </tr>`;
            }

            output += "</table>";
            document.getElementById("tabellaDati").innerHTML = output;
        }

        function mostraVistaGrafico() {
            document.getElementById("tabellaDati").style.display = "none";
            document.getElementById("graficoView").style.display = "block";
        }

        async function generaGrafico() {
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            const prodottoFiltro = document.getElementById('prodottoSelect').value;
            const response = await fetch('/grafico');
            const storico = await response.json();

            const aggregati = {};
            storico.forEach(riga => {
                const dataRiga = riga.Data;
                const prodotto = riga.Prodotto;
                if (
                    (!start || dataRiga >= start) &&
                    (!end || dataRiga <= end) &&
                    (prodottoFiltro === "tutti" || prodotto === prodottoFiltro)
                ) {
                    const mese = dataRiga.substring(0, 7);
                    aggregati[mese] = (aggregati[mese] || 0) + parseFloat(riga["Quantita"]);
                }
            });

            const labels = Object.keys(aggregati);
            const values = Object.values(aggregati);

            const ctx = document.getElementById('graficoProduzione').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `Quantit√† prodotta (${prodottoFiltro})`,
                        data: values,
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function tornaAllaTabella() {
            document.getElementById("graficoView").style.display = "none";
            document.getElementById("tabellaDati").style.display = "block";
        }
    </script>
</body>

</html>